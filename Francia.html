<html>

<head>

	<title>Francia</title>
	<script type="text/javascript" src="js/libs/jquery/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="js/libs/three/three2.js"></script>
	<script type="text/javascript" src="js/libs/three/MTLLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/FBXLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/OBJLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/inflate.min.js"></script>
	<script type="text/javascript" src="js/libs/jquery/controller.js"></script>
	<script type="text/javascript">

		//Animaciones
		//

		var scene;
		var camera;
		var renderer;
		var controls;
		var objectosConColision = [];
		var clock;
		var deltaTime;
		var keys = {};
		var button = {};
		var flag = false;
		var jugadores = [];
		var movements = [];
		var action1;
		var action2;
		var action3;
		var action4;

		var action_1;
		var action_2;
		var action_3;
		var action_4;
		// TODO: Modelo con animacion.var
		var mixers = [];
		var mixers_2 = [];
		// TODO: End Modelo Animacion.

		var lifebar1;
		var lifebar2;
		var greenbar1;
		var greenbar2;

		var isWorldReady = [false, false];

		var rayCaster;

		$(document).ready(function () {

			rayCaster = new THREE.Raycaster();

			setupScene();

			camera.misRayos = [
				new THREE.Vector3(0, 0, 1),
				new THREE.Vector3(0, 0, -1),
				new THREE.Vector3(1, 0, 0),
				new THREE.Vector3(-1, 0, 0)
			];


			loadOBJWithMTL("assets/", "colision.obj", "colision.mtl", (object) => {
				object.position.z = -30;

				var box7 = object.clone();
				box7.position.x = -6;
				box7.position.z = 0;
				box7.rotation.y = THREE.Math.degToRad(-90);

				var box8 = object.clone();
				box8.position.x = 8;
				box8.position.z = 0;
				box8.rotation.y = THREE.Math.degToRad(90);


				scene.add(box7);
				scene.add(box8);


				objectosConColision.push(box7);
				objectosConColision.push(box8);

				isWorldReady[0] = true;
			});

			loadOBJWithMTL("assets/", "escenario2.obj", "escenario2.mtl", (object) => {
				object.position.z = -10;
				object.position.x = 3;


				scene.add(object);
				isWorldReady[1] = true;
			});

			loadOBJWithMTL("assets/", "HPbar1.obj", "HPbar1.mtl", (bar1) => {
				bar1.position.z = -10;
				bar1.position.x = -5;
				bar1.position.y = -5;

				bar1.name = "bar1";

				scene.add(bar1);
				isWorldReady[2] = true;
			});

			loadOBJWithMTL("assets/", "HP1.obj", "HP1.mtl", (bar1) => {
				bar1.position.z = -10;
				bar1.position.x = -5;
				bar1.position.y = -5;

				bar1.name = "hp1";

				scene.add(bar1);
				isWorldReady[2] = true;
			});

			loadOBJWithMTL("assets/", "HPbar2.obj", "HPbar2.mtl", (bar2) => {
				bar2.position.z = -10;
				bar2.position.x = -1;
				bar2.position.y = -5;

				bar2.name = "bar2";

				scene.add(bar2);
				isWorldReady[3] = true;
			});

			loadOBJWithMTL("assets/", "HP2.obj", "HP2.mtl", (bar2) => {
				bar2.position.z = -10;
				bar2.position.x = -1;
				bar2.position.y = -5;

				bar2.name = "hp2";

				scene.add(bar2);
				isWorldReady[3] = true;
			});
				// create an AudioListener and add it to the camera
				const listener = new THREE.AudioListener();
				camera.add( listener );

				// create a global audio source
				const sound = new THREE.Audio( listener );

				// load a sound and set it as the Audio object's buffer
				const audioLoader = new THREE.AudioLoader();
				audioLoader.load( 'assets/Theme-OST.ogg', function( buffer ) {
					sound.setBuffer( buffer );
					sound.setLoop( true );
					sound.setVolume( 0.5 );
					sound.play();
				});
			var loader = new THREE.FBXLoader();
			loader.load('assets/ChaosAnimations.fbx', function (personaje) {

				personaje.mixer = new THREE.AnimationMixer(personaje);

				mixers.push(personaje.mixer);
				const clips = personaje.animations;
				const forwardC = THREE.AnimationClip.findByName(clips, 'Forward');
				const idleC = THREE.AnimationClip.findByName(clips, 'Idle');
				const backwardC = THREE.AnimationClip.findByName(clips, 'Backward');
				const headbuttC = THREE.AnimationClip.findByName(clips, 'HeadButt');
				const Punch1C = THREE.AnimationClip.findByName(clips, 'Punch1');
				const Punch2C = THREE.AnimationClip.findByName(clips, 'Punch2');
				const Kick1C = THREE.AnimationClip.findByName(clips, 'Kick1');
				const Kick2C = THREE.AnimationClip.findByName(clips, 'Kick2');
				const TauntC = THREE.AnimationClip.findByName(clips, 'Taunt');
				const VictoryC = THREE.AnimationClip.findByName(clips, 'Victory');
				const DefeatC = THREE.AnimationClip.findByName(clips, 'Defeat');

				actionforwardC = personaje.mixer.clipAction(forwardC);
				actionIdleC = personaje.mixer.clipAction(idleC);
				actionbackwardC = personaje.mixer.clipAction(backwardC);
				actionHeadbuttC = personaje.mixer.clipAction(headbuttC);
				actionPunch1C = personaje.mixer.clipAction(Punch1C);
				actionPunch1C.setLoop(THREE.LoopOnce);
				actionPunch2C = personaje.mixer.clipAction(Punch2C);
				actionPunch2C.setLoop(THREE.LoopOnce);
				actionKick1C = personaje.mixer.clipAction(Kick1C);
				actionKick1C.setLoop(THREE.LoopOnce);
				actionKick2C = personaje.mixer.clipAction(Kick2C);
				actionKick2C.setLoop(THREE.LoopOnce);
				actionTauntC = personaje.mixer.clipAction(TauntC);
				actionVictoryC = personaje.mixer.clipAction(VictoryC);
				actionDefeatC = personaje.mixer.clipAction(DefeatC);

				actionIdleC.play();


				personaje.position.z = -6;
				personaje.position.x = 0;
				personaje.position.y = .5;
				personaje.scale.set(0.03, 0.03, 0.03);
				personaje.rotation.y = THREE.Math.degToRad(90);
				personaje.misRayos = [
					new THREE.Vector3(0, 0, 1),
					new THREE.Vector3(0, 0, -1),
					new THREE.Vector3(1, 0, 0),
					new THREE.Vector3(-1, 0, 0)
				];


				scene.add(personaje);

				jugadores.push(personaje);
				mixers_2[0].addEventListener('finished', aber);
			});

			var loader2 = new THREE.FBXLoader();
			loader2.load('assets/GohanAnimations1.fbx', function (personaje2) {

				personaje2.mixer = new THREE.AnimationMixer(personaje2);

				mixers_2.push(personaje2.mixer);

				const clips = personaje2.animations;

				const forward = THREE.AnimationClip.findByName(clips, 'Forward');
				const idle = THREE.AnimationClip.findByName(clips, 'Idle');
				const backward = THREE.AnimationClip.findByName(clips, 'Backward');
				const headbutt = THREE.AnimationClip.findByName(clips, 'HeadButt');
				const Punch1 = THREE.AnimationClip.findByName(clips, 'Punch1');
				const Punch2 = THREE.AnimationClip.findByName(clips, 'Punch2');
				const Kick1 = THREE.AnimationClip.findByName(clips, 'Kick1');
				const Kick2 = THREE.AnimationClip.findByName(clips, 'Kick2');
				const Taunt = THREE.AnimationClip.findByName(clips, 'Taunt');
				const Victory = THREE.AnimationClip.findByName(clips, 'Victory');
				const Defeat = THREE.AnimationClip.findByName(clips, 'Defeat');

				actionforward = personaje2.mixer.clipAction(forward);
				actionIdle = personaje2.mixer.clipAction(idle);
				actionbackward = personaje2.mixer.clipAction(backward);
				actionHeadbutt = personaje2.mixer.clipAction(headbutt);
				actionPunch1 = personaje2.mixer.clipAction(Punch1);
				actionPunch1.setLoop(THREE.LoopOnce);
				actionPunch2 = personaje2.mixer.clipAction(Punch2);
				actionPunch2.setLoop(THREE.LoopOnce);
				actionKick1 = personaje2.mixer.clipAction(Kick1);
				actionKick1.setLoop(THREE.LoopOnce);
				actionKick2 = personaje2.mixer.clipAction(Kick2);
				actionKick2.setLoop(THREE.LoopOnce);
				actionTaunt = personaje2.mixer.clipAction(Taunt);
				actionVictory = personaje2.mixer.clipAction(Victory);
				actionDefeat = personaje2.mixer.clipAction(Defeat);

				actionIdle.play();

				

				personaje2.position.z = -6;
				personaje2.position.x = 10;
				personaje2.position.y = .5;
				personaje2.scale.set(0.03, 0.03, 0.03);
				personaje2.rotation.y = THREE.Math.degToRad(-90);
				personaje2.misRayos = [
					new THREE.Vector3(0, 0, 1),
					new THREE.Vector3(0, 0, -1),
					new THREE.Vector3(1, 0, 0),
					new THREE.Vector3(-1, 0, 0)
				];


				scene.add(personaje2);

				jugadores.push(personaje2);

				mixers_2[0].addEventListener('finished', aber);
			});
			
			render();

			document.addEventListener('keydown', onKeyDown);
			document.addEventListener('keyup', onKeyUp);

			
		});

		function aber(){
			flag = false;
			actionIdle.play();
			console.log("a");
		}

		function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
			var mtlLoader = new THREE.MTLLoader();
			mtlLoader.setPath(path);
			mtlLoader.load(mtlFile, (materials) => {

				var objLoader = new THREE.OBJLoader();
				objLoader.setMaterials(materials);
				objLoader.setPath(path);
				objLoader.load(objFile, (object) => {
					onLoadCallback(object);
				});

			});
		}


		function onKeyDown(event) {
			console.log("key: " + String.fromCharCode(event.keyCode));
			keys[String.fromCharCode(event.keyCode)] = true;
			if (String.fromCharCode(event.keyCode) == "A") {
				if (!flag) {
					mixers[0].stopAllAction();
					actionforwardC.time = 5;
					actionforwardC.play();
					flag = true;
				}
				if (actionforwardC.time >= 0 && actionforwardC.time <= 0.15) {
					actionforwardC.time = 5;
				}
			}
			if (String.fromCharCode(event.keyCode) == "D") {
				if (!flag) {
					mixers[0].stopAllAction();
					actionbackwardC.time = 6;
					actionbackwardC.play();
					flag = true;
				}
				if (actionbackwardC.time >= 0 && actionbackwardC.time <= 0.10) {
					actionbackwardC.time = 6;
				}
			}
			if (String.fromCharCode(event.keyCode) == "d") {
				if (!flag) {
					mixers_2[0].stopAllAction();
					actionforward.time = 5;
					actionforward.play();
					flag = true;
				}
				if (actionforward.time >= 0 && actionforward.time <= 0.15) {
					actionforward.time = 5;
				}
			}
			if (String.fromCharCode(event.keyCode) == "f") {
				if (!flag) {
					mixers_2[0].stopAllAction();
					actionbackward.time = 6;
					actionbackward.play();
					flag = true;
				}
				if (actionbackward.time >= 0 && actionbackward.time <= 0.10) {
					actionbackward.time = 6;
				}
			}
			if (String.fromCharCode(event.keyCode) == "g") {
				if (!flag) {
					mixers_2[0].stopAllAction();
					actionPunch1.time = 7;
					actionPunch1.play();
					flag = true;
				}
			}
			if (String.fromCharCode(event.keyCode) == "i") {
				if (!flag) {
					mixers_2[0].stopAllAction();
					actionPunch2.time = 8;
					actionPunch2.play();
					flag = true;
				}
			}
			if (String.fromCharCode(event.keyCode) == "a") {
				if (!flag) {
					mixers_2[0].stopAllAction();
					actionKick1.time = 9.5;
					actionKick1.play();
					flag = true;
				}
			}
			if (String.fromCharCode(event.keyCode) == "c") {
				if (!flag) {
					mixers_2[0].stopAllAction();
					actionKick2.time = 11.5;
					actionKick2.play();
					flag = true;
				}
			}
		}
		function onKeyUp(event) {
			keys[String.fromCharCode(event.keyCode)] = false;
			if (String.fromCharCode(event.keyCode) == "d" || String.fromCharCode(event.keyCode) == "f") {
				flag = false;
				mixers_2[0].stopAllAction();
				actionIdle.play();
			}
			if (String.fromCharCode(event.keyCode) == "A" || String.fromCharCode(event.keyCode) == "D") {
				flag = false;
				mixers[0].stopAllAction();
				actionIdleC.play();
			}
		}



		function render() {
			requestAnimationFrame(render);
			deltaTime = clock.getDelta();

			//ANIMACION PERSONAJE 1
			if (mixers.length > 0) {
				for (var i = 0; i < mixers.length; i++) {
					mixers[i].update(deltaTime);
				}

			}

			//ANIMACION PERSONAJE 2
			if (mixers_2.length > 0) {
				for (var i = 0; i < mixers_2.length; i++) {
					mixers_2[i].update(deltaTime);}

			}
			var forward = 0;
			var forward2 = 0;
			var forward3 = 0;
			lifebar1 = scene.getObjectByName("bar1");
			lifebar2 = scene.getObjectByName("bar2");
			greenbar1 = scene.getObjectByName("hp1");
			greenbar2 = scene.getObjectByName("hp2");


			if (keys["A"] ||  button[2]) {
				forward = -5;
			} else if (keys["D"]) {
				forward = 5;

			}

			if (keys["d"]) {
				forward2 = 5;
				//flag = true;
			} else if (keys["f"]) {
				forward2 = -5;
			}

			if (keys["'"]) {
				forward3 = 100;

			} else if (keys["%"]) {

				forward3 = -100;
			}

			movements[1] = forward;
			movements[0] = forward2;

			if (isWorldReady[0] && isWorldReady[1]) {

				jugadores[0].translateZ(movements[0] * deltaTime);
				jugadores[1].translateZ(movements[1] * deltaTime);
				camera.translateX(forward3 * deltaTime);
				lifebar1.translateX(forward3 * deltaTime);
				lifebar2.translateX(forward3 * deltaTime);
				greenbar1.translateX(forward3 * deltaTime);
				greenbar2.translateX(forward3 * deltaTime);

				for (var i = 0; i < camera.misRayos.length; i++) {

					var rayo = camera.misRayos[i];

					rayCaster.set(camera.position, rayo);

					var colisiones = rayCaster.intersectObjects(
						objectosConColision,
						true
					);

					if (colisiones.length > 0) {

						if (colisiones[0].distance < 1) {
							camera.translateX(-(forward3 * deltaTime));
							lifebar1.translateX(-(forward3 * deltaTime));
							lifebar2.translateX(-(forward3 * deltaTime));
							greenbar1.translateX(-(forward3 * deltaTime));
							greenbar2.translateX(-(forward3 * deltaTime));

							console.log("Estamos colisionando con algo");
						}
					}

				}

				for (var j = 0; j < jugadores.length; j++) {
					for (var i = 0; i < jugadores[j].misRayos.length; i++) {

						var rayo = jugadores[j].misRayos[i];

						rayCaster.set(jugadores[j].position, rayo);

						var colisiones = rayCaster.intersectObjects(
							objectosConColision,
							true
						);

						if (colisiones.length > 0) {

							if (colisiones[0].distance < 1) {
								jugadores[j].translateZ(-(movements[j] * deltaTime));
								console.log("Estamos colisionando con algo");
							}
						}

					}
				}
			}


			renderer.render(scene, camera);
		}

		function setupScene() {
			var visibleSize = { width: window.innerWidth, height: window.innerHeight };
			clock = new THREE.Clock();
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 100);
			camera.rotation.x = THREE.Math.degToRad(-11);;
			camera.position.z = 3;
			camera.position.y = 6;
			camera.position.x = 5;

			renderer = new THREE.WebGLRenderer({ precision: "mediump" });
			renderer.setClearColor(new THREE.Color(0, 0, 0));
			renderer.setPixelRatio(visibleSize.width / visibleSize.height);
			renderer.setSize(visibleSize.width, visibleSize.height);

			var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
			scene.add(ambientLight);

			var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 0), 0.4);
			directionalLight.position.set(0, 0, 1);
			scene.add(directionalLight);

			var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
			grid.position.y = -1;
			scene.add(grid);



			$("#scene-section").append(renderer.domElement);
		}


	</script>
</head>

<body>

	<div id="scene-section"></div>

</body>

</html>